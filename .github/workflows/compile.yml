name: Compile Document and Deploy

permissions:
    contents: read
    pages: write
    id-token: write

on:
    push:
        branches:
            - master

jobs:
    compile:
      name: Compile LaTeX notes
      runs-on: ubuntu-latest
      if: ${{ contains(github.event.head_commit.message, '@docker') }}
      steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Set up Python
            uses: actions/setup-python@v5
            with:
                python-version: 3.8

          - name: Install dependencies
            run: |
                python -m pip install --upgrade pip
                pip install -r build/requirements.txt

          - name: Include disclaimer header
            run: |
                chmod +x ./build/add-disclaimer.sh
                ./build/add-disclaimer.sh

          - name: Set up LaTeX docker and compile
            uses: xu-cheng/latex-action@v3
            with:
              root_file: COMP2120-Notes.tex
              work_in_root_file_dir: true
              latexmk_shell_escape: true

          - name: Upload artifact
            uses: actions/upload-artifact@v4
            with:
              name: notes
              path: COMP2120-Notes.pdf
              retention-days: 1

    deploy:
      name: Build and deploy static site
      runs-on: ubuntu-latest
      needs: build-by-miktex
      if: ${{ !contains(github.event.head_commit.message, '@nodeploy') }}
      environment:
          name: github-pages
          url: ${{ steps.deployment.outputs.page_url }}
      steps:
          - name: Checkout repository
            uses: actions/checkout@v4
            
          - name: Download artifact
            uses: actions/download-artifact@v4
            with:
              name: notes-miktex
              path: gh-pages
              merge-multiple: true

          - name: Upload static files as artifact
            uses: actions/upload-pages-artifact@v3
            with:
              path: gh-pages

          - name: Configure pages
            uses: actions/configure-pages@v5

          - name: Deploy to GitHub Pages
            id: deployment
            uses: actions/deploy-pages@v4
              
    build-by-miktex:
      name: Build by MiKTeX
      runs-on: ubuntu-22.04
      env:
        APT_LIST: "" ## Evaluated at runtime
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
        ## Configure GPG key
        - name: Configure MiKTeX GPG key
          run: |
            curl -fsSL https://miktex.org/download/key | sudo tee /usr/share/keyrings/miktex-keyring.asc > /dev/null
            echo "deb [signed-by=/usr/share/keyrings/miktex-keyring.asc] https://miktex.org/download/ubuntu jammy universe" | sudo tee /etc/apt/sources.list.d/miktex.list
        ## Prepare the environment
        - name: Update apt-get sources
          run: sudo apt-get update
        - name: Get dependencies list
          run: echo "APT_LIST=$(awk '{$1=$1}1' OFS=' ' RS='' build/apt-list.txt)" >> "$GITHUB_ENV"
        - name: Include disclaimer header
          run: |
              chmod +x ./build/add-disclaimer.sh
              ./build/add-disclaimer.sh
        ## Install MiKTeX
        - name: Install MiKTeX and dependencies
          uses: awalsh128/cache-apt-pkgs-action@v1
          with:
            packages: ${{ env.APT_LIST }}
        - uses: actions/setup-python@v5
          with:
            python-version: '3.13'
            cache: 'pip'
        - name: Install Python packages
          run: |
            python -m pip install --upgrade pip
            pip install -r build/requirements.txt
        ## Restore LaTeX packages cache
        - name: Cache LaTeX packages
          uses: actions/cache@v4
          with:
            key: miktex-pkg-${{ runner.os }}-${{ hashFiles('packages.tex', 'cheatsheet/packages.tex') }}
            path: ~/.miktex
        ## Finish MiKTeX setup
        - name: Finish MiKTeX setup
          run: |
            miktexsetup finish
            initexmf --set-config-value [MPM]AutoInstall=1
            initexmf --enable-installer
            initexmf --update-fndb
            initexmf --mklinks
            initexmf --mkmaps
        - name: Fix PATH
          run: echo "PATH=$HOME/bin:$PATH" >> "$GITHUB_ENV"
        ## Compile the document
        - name: Compile LaTeX notes
          id: compile
          run: latexmk -shell-escape -interaction=nonstopmode -pdf -outdir=. -f COMP2120-Notes.tex
        - name: Compile LaTeX cheatsheet
          id: compile-cheatsheet
          run: |
            latexmk -shell-escape -interaction=nonstopmode -pdf -outdir=./cheatsheet -f ./cheatsheet/COMP2120-Cheatsheet.tex
            mv ./cheatsheet/COMP2120-Cheatsheet.pdf .
        ## Upload the artifact
        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: notes-miktex
            path: |
              COMP2120-Notes.pdf
              COMP2120-Cheatsheet.pdf
            retention-days: 1
        ## Upload logs
        - name: Upload compile logs
          if: ${{ always() }}
          uses: actions/upload-artifact@v4
          with:
            name: logs
            path: /home/runner/.miktex/texmfs/data/miktex/log/
            retention-days: 14
