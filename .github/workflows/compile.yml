name: Compile Document and Deploy

permissions:
    contents: read
    pages: write
    id-token: write

on:
    push:
        branches:
            - master

jobs:
    compile:
        name: Compile LaTeX notes
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: 3.8

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Set up LaTeX docker and compile
              uses: xu-cheng/latex-action@v3
              with:
                root_file: COMP2120-Notes.tex
                work_in_root_file_dir: true
                latexmk_shell_escape: true

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: notes
                path: COMP2120-Notes.pdf
                retention-days: 1

    deploy:
        name: Build and deploy static site
        runs-on: ubuntu-latest
        needs: compile
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: Create HTML file
              run: |
                  mkdir out
                  echo "<!DOCTYPE html><html><head><title>COMP2120 Notes</title><meta http-equiv='refresh' content='0;url=COMP2120-Notes.pdf'></head><body><a href="COMP2120-Notes.pdf">Download Notes</a></body></html>" > out/index.html

            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                name: notes
                path: out
                merge-multiple: true

            - name: Upload static files as artifact
              uses: actions/upload-pages-artifact@v3
              with:
                path: out

            - name: Configure pages
              uses: actions/configure-pages@v5

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
              
    build-by-miktex:
      name: Build by MiKTeX
      runs-on: ubuntu-22.04
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
        ## Configure GPG key
        - name: Configure MiKTeX GPG key
          run: |
            curl -fsSL https://miktex.org/download/key | sudo tee /usr/share/keyrings/miktex-keyring.asc > /dev/null
            echo "deb [signed-by=/usr/share/keyrings/miktex-keyring.asc] https://miktex.org/download/ubuntu jammy universe" | sudo tee /etc/apt/sources.list.d/miktex.list
        ## Prepare the environment
        - name: Update apt-get sources
          run: sudo apt-get update
        - name: Get dependencies list
          run: export APT_LIST=$(awk '{$1=$1}1' OFS='NNNNN' RS='' apt-list.txt)
        ## Install MiKTeX
        - name: Install MiKTeX and dependencies
          uses: awalsh128/cache-apt-pkgs-action@v1
          with:
            packages: ${{ env.APT_LIST }}
        - name: Finish MiKTeX setup
          run: |
            miktexsetup finish
            initexmf --set-config-value [MPM]AutoInstall=1
            miktex packages update
        ## Compile the document
        - name: Compile LaTeX notes
          run: latexmk -shell-escape -pdf -interaction=nonstopmode -outdir=. COMP2120-Notes.tex
        ## Upload the artifact
        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: notes-miktex
            path: COMP2120-Notes.pdf
            retention-days: 1