name: Compile Document and Deploy

permissions:
    contents: read
    pages: write
    id-token: write

on:
    push:
        branches:
            - master

jobs:
    compile:
        name: Compile LaTeX notes
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: 3.8

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Install Docker
              run: |
                  sudo apt-get update
                  sudo install -m 0755 -d /etc/apt/keyrings
                  sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                  sudo chmod a+r /etc/apt/keyrings/docker.asc
                  echo \
                    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                    $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
                    sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                  sudo apt-get update

            - name: Cache install Docker
              uses: awalsh128/cache-apt-pkgs-action@v1
              with:
                packages: docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin 

            - name: Compile with MiKTeX image
              run: |
                  docker run -ti -v miktex:/var/lib/miktex -v "$(pwd)":/miktex/work -e MIKTEX_UID=$(id -u) miktex/miktex:basic \
                    latexmk --shell-escape -synctex=1 -interaction=nonstopmode -file-line-error -pdf COMP2120-Notes.tex

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: notes
                path: COMP2120-Notes.pdf
                retention-days: 1

    build-deploy:
        name: Build and deploy static site
        runs-on: ubuntu-latest
        needs: compile
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: Create HTML file
              run: |
                  mkdir out
                  echo "<!DOCTYPE html><html><head><title>COMP2120 Notes</title><meta http-equiv='refresh' content='0;url=COMP2120-Notes.pdf'></head><body><a href="COMP2120-Notes.pdf">Download Notes</a></body></html>" > out/index.html

            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                name: notes
                path: out
                merge-multiple: true

            - name: Upload static files as artifact
              uses: actions/upload-pages-artifact@v3
              with:
                path: out

            - name: Configure pages
              uses: actions/configure-pages@v5

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
              